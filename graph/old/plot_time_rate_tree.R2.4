#! /mnt/hd1/home/sishuo/program/R/R-4.3.2/bin/Rscript

# with color gradual change but not work well

#################################################
# Load required libraries
library(ggtree)
library(ggplot2)
library(gridExtra)
library(scales)
library(phytools)
library(ape)

#################################################
# Parse command-line arguments
args <- commandArgs(trailingOnly = TRUE)

timetrees <- c()
ratetrees <- c()
output_file <- "output.pdf"

i <- 1
while(i <= length(args)) {
    if(args[i] == "-t") {
        timetrees <- c(timetrees, args[i+1])
        i <- i + 2
    } else if(args[i] == "-r") {
        ratetrees <- c(ratetrees, args[i+1])
        i <- i + 2
    } else if(args[i] == "-o") {
        output_file <- args[i+1]
        i <- i + 2
    } else {
        i <- i + 1
    }
}

if(length(timetrees) != length(ratetrees)) {
    stop("Error: Number of time trees (-t) must match number of rate trees (-r)")
}

if(length(timetrees) < 1) {
    stop("Usage: Rscript script.R -t timetree1 -r ratetree1 [-t timetree2 -r ratetree2] [-o output.pdf]")
}

#################################################
# Compute rate range for gradient mapping
get_rate_range <- function(rate_files) {
    all_rates <- numeric()
    for(file in rate_files) {
        tree <- read.tree(file)
        all_rates <- c(all_rates, tree$edge.length)
    }
    return(range(all_rates, na.rm = TRUE))
}

rate_range <- get_rate_range(ratetrees)
rate_range[2] <- rate_range[2] * 1.2
n_color_stops <- 100  # Increase for smoother transition
rate_breaks <- seq(0, rate_range[2], length.out = n_color_stops)
rate_values <- rate_breaks

#################################################
# Extract time uncertainty intervals for nodes
extract_node_intervals <- function(tree, tree_df) {
    node_support <- lapply(seq_along(tree$node.label), function(i) {
        x <- tree$node.label[i]
        if (grepl("-", x)) {
            range_vals <- as.numeric(unlist(strsplit(x, "-")))
            node_id <- i + length(tree$tip.label)
            if (node_id > nrow(tree_df)) {
                node_id <- nrow(tree_df)  # Ensure root inclusion
            }
            y_pos <- tree_df$y[node_id]
            return(data.frame(node=node_id, 
                              min_age=max(tree_df$x) - range_vals[2], 
                              max_age=max(tree_df$x) - range_vals[1], 
                              y_position=y_pos))
        }
        return(data.frame(node=NA, min_age=NA, max_age=NA, y_position=NA))
    })
    return(na.omit(do.call(rbind, node_support)))
}

#################################################
# Interpolate branch colors for smooth transitions
interpolate_branch_colors <- function(tree, rate_values, n_segments = 50) {
    branch_data <- data.frame()
    
    for (i in 1:nrow(tree$edge)) {
        start_node <- tree$edge[i, 1]
        end_node <- tree$edge[i, 2]
        start_x <- phytools::nodeHeights(tree)[i, 1]
        end_x <- phytools::nodeHeights(tree)[i, 2]

        # Ensure rate values are finite
        start_rate <- ifelse(is.finite(rate_values[start_node]), rate_values[start_node], 0)
        end_rate <- ifelse(is.finite(rate_values[end_node]), rate_values[end_node], start_rate)

        # Generate interpolated values
        interpolated_x <- seq(start_x, end_x, length.out = n_segments + 1)
        interpolated_rate <- seq(start_rate, end_rate, length.out = n_segments + 1)

        branch_segment <- data.frame(
            x_start = interpolated_x[-length(interpolated_x)],
            x_end = interpolated_x[-1],
            y = rep(end_node, n_segments),
            rate = interpolated_rate[-1]
        )

        branch_data <- rbind(branch_data, branch_segment)
    }
    
    return(branch_data)
}


#################################################
# Generate tree plots with gradient colors and uncertainty bars
create_tree_plot <- function(time_file, rate_file) {
    time_tree <- read.tree(time_file)
    rate_tree <- read.tree(rate_file)

    tree_height <- max(phytools::nodeHeights(time_tree))
    max_label_length <- max(nchar(time_tree$tip.label))

    plot_data <- data.frame(
        node = time_tree$edge[,2],
        rate = rate_tree$edge.length
    )

    tree_df <- fortify(time_tree)  # Extract correct tree coordinates
    node_intervals <- extract_node_intervals(time_tree, tree_df)  # Get uncertainty info
    branch_segments <- interpolate_branch_colors(time_tree, plot_data$rate)  # Smooth colors

    p <- ggtree(time_tree, size=1.2) +
        geom_segment(data=branch_segments, 
                     aes(x=x_start, xend=x_end, y=y, yend=y, color=rate), 
                     size=1.5) +  # Apply gradient colors in branches
        scale_color_gradientn(
            name = "Evolutionary Rate",
            #colors = colorRampPalette(c("blue", "cyan", "white", "yellow", "red"))(100),  
            colors = colorRampPalette(c("blue", "red"))(100),  
            values = seq(0, 1, length.out = 100),  
            limits = rate_range,
            breaks = pretty_breaks(n=8)(rate_range),  
            guide = guide_colorbar(
                direction = "vertical",
                barwidth = 1.5,
                barheight = 15,
                title.position = "top",
                title.hjust = 0.5,
                frame.colour = "black",
                ticks.colour = "black"
            )
        ) +
        geom_tiplab(size = 4, align = TRUE, hjust = 0, offset = 0.02 * tree_height) +
        geom_segment(data=node_intervals, 
                     aes(x=min_age, xend=max_age, y=y_position, yend=y_position),  
                     color="grey", size=1, alpha=0.6) +  # Corrected confidence intervals
        theme_tree2() +
        theme(
            legend.position = "right",
            legend.justification = "center",
            plot.title = element_text(size=10, hjust=0.5),
            legend.text = element_text(size=8),
            legend.title = element_text(size=9, face="bold"),
            legend.margin = margin(0, 20, 0, 0),
            plot.margin = unit(c(1, max_label_length*0.2, 1, 1), "cm")
        ) +
        xlim(-0.5, tree_height * 1.5)  

    return(p)
}

#################################################
# Generate tree plots from input files
plot_list <- list()
for(i in 1:length(timetrees)) {
    plot_list[[i]] <- create_tree_plot(timetrees[i], ratetrees[i])
}

# Simplified PDF dimensions
n_plots <- length(plot_list)
pdf_width <- ifelse(n_plots == 1, 14, 22)
pdf_height <- 10

# Output plots in a properly arranged format
pdf(output_file, width=pdf_width, height=pdf_height)
grid.arrange(
    grobs = plot_list,
    nrow = n_plots,  
    ncol = 1    
)
dev.off()

cat("Successfully created", n_plots, "tree plots in", output_file, "\n")
cat("Color scale range:", signif(rate_range[1],3), "to", signif(rate_range[2],3), "\n")
